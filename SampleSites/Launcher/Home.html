<!DOCTYPE html>
<html>
  <head>
    <title>New Tab</title>
      <link rel="stylesheet" href="Bstyle.css">
    <script>
      function setup() {
        //picks a random number between 1 and 15
        var n = Math.floor((Math.random() * 15) + 1);
        localStorage.setItem("backgroundNo",n)
        var location = localStorage.getItem("Location");
          //sets the background to the random image
          document.body.style.backgroundImage = "url('Images/image-" + n + ".jpg')";
              //calls some other functions to intiate the site
              startTime();
              logCheck();
              fontcolor(n);
              //getLocation();
              getWeatherAPIManual(location);
      }

      function fontcolor(bgImgNo){
        if(bgImgNo > 10){
          document.getElementById("time").style.color = "#403D39";
          document.getElementById("greeting").style.color = "#403D39";
          document.getElementById("temp").style.color = "#403D39";
          document.getElementById("description").style.color = "#403D39";
          document.getElementById("city").style.color = "#403D39";
          document.getElementById("locationText").style.color = "#403D39";
        } else{
          document.getElementById("time").style.color = "white";
          document.getElementById("greeting").style.color = "white";
          document.getElementById("temp").style.color = "white";
          document.getElementById("description").style.color = "white";
          document.getElementById("city").style.color = "white";
          document.getElementById("locationText").style.color = "white";
        }
      }

      function logOut() {
        //deletes the username from local storage
        localStorage.removeItem("Username");
        //checks to see if the user is logged in (brings up the log in screen)
        logCheck();
      }

        function logCheck() {
          //checks what the username is currently set to
          var storedValue = localStorage.getItem("Username");
          //checks if a username has been set
          if (storedValue == null) {
            //brings up the log in screen
            document.getElementById("log").style.display = "block";
            document.getElementById("log").style.bottom = "700px";
            //hides the login screen
          } else {document.getElementById("log").style.display = "none";
            };
          //sets up the on-screen greeting
          greeting();
        };

        function greeting() {
          //gets the current username
          var storedValue = localStorage.getItem("Username");
          var today = new Date();
          var Hours = today.getHours();
          var g = " "
          if (Hours < 12) {g = "Good Morning "}
          if (Hours > 11) {g = "Good Afternoon "}
          if (Hours > 17) {g = "Good Evening "}
          if (storedValue !== null) {document.getElementById("greeting").innerHTML = g + storedValue;
              };
        };

        function startTime() {
          var today = new Date();
          var h = today.getHours();
          var m = today.getMinutes();
          var e = today.getHours();
          var s = today.getSeconds();
          var g = ":";
          var x = "AM";
          var y = (s/2);
          m = checkTime(m);
          s = checkTime(s);
          if (h > 12) {
            h = h - 12;
            };
          if (e > 11) {
            x = "PM";
            };
          if (y === parseInt(y, 10)) {
            g = " "
            };

          document.getElementById('time').innerHTML = h + g + m + x;
          var t = setTimeout(startTime, 500);
        };

        function checkTime(i) {
          if (i < 10) {i = "0" + i};  // add zero in front of numbers < 10
          return i;
        };

        function savename() {
          var input = document.getElementById("input").value;
          localStorage.setItem("Username",input);
          logCheck();
        };

        function locationUpdate(){
          var location = document.getElementById('locationInput').value;
          localStorage.setItem("Location",location);
          getWeatherAPIManual(location);
        }

        function getWeatherAPIManual(location){
          var key = '354fd90e5e5dbc3b9f113f3f703a194c';
          fetch('https://api.openweathermap.org/data/2.5/weather?q=' + location + '&appid=' + key + '&units=metric')
          .then(function(resp) { return resp.json() })
          .then(function(data) {
              displayWeather(data);
            })
            .catch(function() {
            });
        }

        function displayWeather(data){
          var descriptions = ["Sunny", "Partly Cloudy", "Mostly Cloudy", "Cloudy", "Light Showers", "Rainy", "Thunder Storms", "Snowy", "Foggy"];
          var iconID = data.weather[0].icon;
          document.getElementById('temp').innerHTML = Math.round(parseFloat(data.main.temp)) + "Â°C";
          document.getElementById('description').innerHTML = data.weather[0].main;
          document.getElementById("city").innerHTML = data.name + " " + data.sys.country;
          var bg = localStorage.getItem("backgroundNo");
          if(bg > 10){
            document.getElementById("icon").src="Icons/1/" + iconID + ".png";
          }else{
            document.getElementById("icon").src="Icons/2/" + iconID + ".png";
          }
          var location = data.name;
          localStorage.setItem("Location",location);
        }

        function getLocation() {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition);
          } else {
            var location = localStorage.getItem("Location");
            window.alert("Geolocation is not supported by this browser. We are using a manually entered location. If this is incorrect please update it manually.")
            getWeatherAPIManual(location);
          }
        }

        function showPosition(position){
          latitude = position.coords.latitude;
          longitude = position.coords.longitude;
          getWeatherAPI(latitude, longitude);
        }

        function getWeatherAPI(latitude, longitude){
          var key = '354fd90e5e5dbc3b9f113f3f703a194c';
          fetch('https://api.openweathermap.org/data/2.5/weather?lat=' + latitude + '&lon=' + longitude + '&appid=' + key + '&units=metric')
          .then(function(resp) { return resp.json() })
          .then(function(data) {
              displayWeather(data);
            })
            .catch(function() {
            });
        }

    </script>
  </head>
  <body onload="setup()" id="main">
    <center>
      <p id="time"></p>
        <form action="https://www.google.com/search" class="searchform" method="get" name="searchform" target="_blank">
          <input name="sitesearch" type="hidden">
          <input autocomplete="on" class="form-control search" name="q" placeholder="Go Google Something" required="required"  type="text" id="searchInput">
            <br>
            <button class="button" type="submit" id="searchButton">Go</button>
        </form>
          <p id="greeting"></p>
            <a href="https://www.youtube.com/" class="sites" id="youtube">Youtube</a>
            <a href="https://keystone-apps.stpeters.sa.edu.au/home" class="sites" id="home">Keystone</a>
            <a href="https://keystone-apps.stpeters.sa.edu.au/tasks" class="sites" id="task">My Tasks</a>
            <a href="https://email.stpeters.sa.edu.au/owa/#path=/mail" class="sites" id="mail">Mail</a>
            <a href="https://cstimer.net/" class="sites" id="timer">CS</a>
            <a href="https://keystone-apps.stpeters.sa.edu.au/timetable" class="sites" id="timetable">Timetable</a>
            <a href="https://keystone-apps.stpeters.sa.edu.au/sportzone/" class="sites" id="sport">Sportzone</a>
            <center>
            <button type="button" onclick="setup()" id="back">New Background</button>
            <button type="button" onclick="logOut()" id="out">Logout</button>
            </center>
          <br>
          <br>
      <div id="weatherStuff">
        <img src="icons/1/unknown.png" id = "icon">
        <p id="temp" class="weatherWidgetText"></p>
        <p id="description" class="weatherWidgetText"></p>
        <p id="city" class="weatherWidgetText"></p>
        <p id ="locationText" class="weatherWidgetText">Location</p>
        <input type="text" id="locationInput" class="weatherWidgetText"></input>
        <button id="locationUpdate" onclick="locationUpdate()" class="weatherWidgetText">Update Location</button>
      </div>
      <div id="log">
          <p class="headings">You need to Login</p>
          <p class="headings">Username</p>
          <input type="text" id="input" class="headings"></input>
          <br><br>
          <button type="button" onclick="savename()">Login</button>
      </div>
    </center>
  </body>
</html>
